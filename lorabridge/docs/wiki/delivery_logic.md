# Алгоритм доставки сообщений

## Очереди
- `outbound` — сообщения от Telegram к Meshtastic.
- `inbound` — ответы от Meshtastic к Telegram.
- Каждая запись — структура `QueuedMessage` с направлением, ID пользователя, счётчиком попыток и временной меткой.

## Повторные попытки
1. Модуль доставки вытягивает сообщение из соответствующей очереди.
2. Если отправка не удалась (исключение, таймаут, FloodWait), `DeliveryManager.record_failure` увеличивает `retries` и возвращает сообщение в очередь.
3. Ретрай продолжается до тех пор, пока сообщение не будет подтверждено либо не будет превышен глобальный лимит (в планах — backoff).

## FloodWait защита
- Если суммарный размер очередей превышает `telegram.floodwait_threshold`, Delivery Manager сообщает о паузе.
- Telegram-модуль вежливо отвечает пользователю: «Сообщение доставлено в буфер…».

## Отсутствие связи
- Если Meshtastic модуль офлайн, сообщения остаются в `outbound`.
- Пользователь получает автоответ о буфере, пока соединение не восстановится.

## Логирование
- Каждая операция очереди логируется в `data/logs/bridge.log`.
- Логи вращаются и не содержат PII (по умолчанию выводятся только ID и технические ошибки).
