# LoraBridge Messenger

## О проекте
LoraBridge Messenger — Python-сервис, который прокладывает безопасный мост между Telegram и Meshtastic, позволяя людям оставаться на связи даже при полном отсутствии интернета. Компоненты построены модульно и поддерживают перезапуск без потери сообщений.

## Как установить
1. Установите Python 3.11+ и git.
2. Клонируйте репозиторий и перейдите в директорию проекта.
3. Создайте виртуальное окружение и установите зависимости из `requirements.txt`.
4. Установите pre-commit хуки командой `pre-commit install` (опционально, но рекомендуется).

## Как запустить
```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python src/main.py run --settings config/settings.json --verbose
```
Запустится CLI, который создаст очереди и эмулированных клиентов Telegram/Meshtastic. Для продакшена замените mock-реализации на реальные адаптеры Serial API и Telegram Bot API.

## Конфигурация
* `config/settings.json` — основные параметры Telegram, Meshtastic, очередей и хранилища.
* `config/.env` — чувствительные данные (токен бота, логины админов). Используйте `config/.env.example` как шаблон.

## Как подключить Telegram-аккаунт
1. Создайте бота через @BotFather и поместите токен в `.env` (`TELEGRAM_BOT_TOKEN`).
2. Добавьте администраторов в `ADMIN_USERNAMES` (через запятую).
3. Убедитесь, что бот включён и принимает личные сообщения.

## Как подключить Meshtastic
1. Подключите Meshtastic-узел по USB и найдите его порт (`/dev/ttyUSB0`, `COM3`).
2. Укажите порт и baudrate в `config/settings.json`.
3. Проверьте, что устройство находится в нужном канале и синхронизировано с остальной mesh-сетью.

## Поддерживаемые команды
Команды из LoRa (и в перспективе из Telegram) обрабатываются модулем `CommandHandler`:
- `/ulist` — показать активных пользователей.
- `/status` — показать состояние очередей.
- `/flush` — очистить исходящую очередь.
- `/help` — подсказка.

## Логика ID
* Каждому Telegram-пользователю автоматически выдаётся ID вида `#1`, `#2`, ...
* Хранилище (`data/users.json`) хранит соответствия последние 48 часов.
* При бездействии запись удаляется, ID может быть переиспользован.
* Сообщения в LoRa должны начинаться с `#ID текст`, чтобы сервис смог правильно маршрутизировать ответ.

## Что уже работает
- Модульная архитектура (Telegram, Meshtastic, очереди, команды, ID).
- Очередь сообщений с повторами и защитой от FloodWait.
- CLI-команда `run` и просмотр активных пользователей.
- Логирование с ротацией файлов.
- Dockerfile и GitHub Actions для базовой CI-проверки.

## Что запланировано
Будущие улучшения подробно описаны в `docs/wiki/future_plans.md` и включают распознавание медиа, перевод, анализ важности и GUI-приложение.

## Таблица возможностей
| Возможность | Статус |
| --- | --- |
| Текст Telegram → LoRa | ✔ Реализовано |
| Текст LoRa → Telegram | ✔ Реализовано |
| Очередь сообщений | ✔ Реализовано |
| Команда /ulist | ✔ Реализовано |
| Автовыдача ID | ✔ Реализовано |
| Распознавание фото | ✖ В разработке |
| Транскрипция голосовых | ✖ В разработке |
| Видео → описание | ✖ В разработке |
| Управление LoRa через команды | ✖ В разработке |
| GUI EXE приложение | ✖ Будет позже |
